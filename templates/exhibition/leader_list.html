{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø¯ÛŒØ±ÛŒØª Ù„ÛŒØ¯Ø±Ù‡Ø§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.fontcdn.ir/Font/Persian/Shabnam/Shabnam.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <style>
    body, * { font-family: 'Shabnam', sans-serif !important; }
  </style>
</head>
<body class="bg-[#0A1F2E] min-h-screen text-[#EAF5F1] font-shabnam">
  <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
      <h1 class="text-2xl md:text-3xl font-bold">
        Ù…Ø¯ÛŒØ±ÛŒØª Ù„ÛŒØ¯Ø±Ù‡Ø§
        {% if user.last_name %}
          ({{ user.last_name }} ğŸ™‹â€â™‚ï¸)
        {% elif user.first_name %}
          ({{ user.first_name }} ğŸ™‹â€â™‚ï¸)
        {% else %}
          ({{ user.username }} ğŸ™‹â€â™‚ï¸)
        {% endif %}
      </h1>

      <div class="flex flex-wrap items-center gap-3">
        <a href="/exhibition-admin/dashboard/"
           class="px-5 py-2.5 bg-[#2E9F73] hover:bg-[#B6E9D6] text-white rounded-2xl text-sm md:text-base font-medium transition-all duration-300 transform hover:scale-105 hover:shadow-[0_0_20px_rgba(46,159,115,0.4)]">
          Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
        </a>
        <button id="add-leader-btn"
                class="px-5 py-2.5 bg-[#B6E9D6] hover:bg-[#2E9F73] text-[#0F3D2E] rounded-2xl text-sm md:text-base font-medium transition-all duration-300 transform hover:scale-105 hover:shadow-[0_0_20px_rgba(46,159,115,0.4)]">
          Ø§ÙØ²ÙˆØ¯Ù† Ù„ÛŒØ¯Ø± Ø¬Ø¯ÛŒØ¯
        </button>
      </div>
    </div>

    <div id="alert-area" class="mb-6"></div>

    <div class="bg-[#0A1F2E]/80 rounded-3xl shadow-2xl overflow-hidden border border-[#2E9F73]/30">
      <div class="overflow-x-auto">
        <table class="w-full min-w-max text-right">
          <thead class="bg-[#0A1F2E]/80">
            <tr>
              <th class="px-4 py-4 md:px-6 md:py-5 text-right text-sm md:text-base font-bold text-[#B6E9D6]">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th>
              <th class="px-4 py-4 md:px-6 md:py-5 text-right text-sm md:text-base font-bold text-[#B6E9D6]">ÙˆØ¶Ø¹ÛŒØª</th>
              <th class="px-4 py-4 md:px-6 md:py-5 text-right text-sm md:text-base font-bold text-[#B6E9D6]">Ø­Ø¶ÙˆØ± ÙØ¹Ø§Ù„</th>
              <th class="px-4 py-4 md:px-6 md:py-5 text-right text-sm md:text-base font-bold text-[#B6E9D6]">Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
          </thead>
          <tbody id="leaders-table-body">
            {% for leader in leaders %}
              <tr class="border-b border-[#2E9F73]/10 hover:bg-[#0A1F2E]/50 transition-all duration-300" data-leader-id="{{ leader.id }}">
                <td class="px-4 py-4 md:px-6 md:py-5 text-sm md:text-base">{{ leader.username }}</td>
                <td class="px-4 py-4 md:px-6 md:py-5 text-sm md:text-base">
                  {% if leader.is_active %}
                    <span class="text-[#EAF5F1]">ÙØ¹Ø§Ù„</span>
                  {% else %}
                    <span class="text-red-400">ØºÛŒØ±ÙØ¹Ø§Ù„</span>
                  {% endif %}
                </td>
                <td class="px-4 py-4 md:px-6 md:py-5 text-sm md:text-base">
                  {% if leader.active_visits > 0 %}
                    <span class="text-[#B6E9D6]">{{ leader.active_visits }} ØºØ±ÙÙ‡</span>
                  {% else %}
                    <span class="text-[#EAF5F1]/50">Ù‡ÛŒÚ†</span>
                  {% endif %}
                </td>
                <td class="px-4 py-4 md:px-6 md:py-5 text-sm md:text-base">
                  <div class="flex flex-wrap gap-2 md:gap-3">
                    <button
                      data-leader-id="{{ leader.id }}"
                      data-username="{{ leader.username }}"
                      class="edit-btn px-3 py-1.5 md:px-4 md:py-2 bg-yellow-600 hover:bg-yellow-500 text-white rounded-xl text-xs md:text-sm transition-all duration-300 hover:scale-105">
                      ÙˆÛŒØ±Ø§ÛŒØ´
                    </button>
                    <button
                      data-leader-id="{{ leader.id }}"
                      data-username="{{ leader.username }}"
                      class="reset-password-btn px-3 py-1.5 md:px-4 md:py-2 bg-[#2E9F73] hover:bg-[#B6E9D6] text-white rounded-xl text-xs md:text-sm transition-all duration-300 hover:scale-105">
                      Ø±ÛŒØ³Øª Ø±Ù…Ø²
                    </button>
                    <button
                      data-leader-id="{{ leader.id }}"
                      data-username="{{ leader.username }}"
                      class="delete-btn px-3 py-1.5 md:px-4 md:py-2 bg-red-700 hover:bg-red-600 text-white rounded-xl text-xs md:text-sm transition-all duration-300 hover:scale-105">
                      Ø­Ø°Ù
                    </button>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="px-6 py-12 text-center text-[#EAF5F1]/50 text-base md:text-lg">
                  Ù‡ÛŒÚ† Ù„ÛŒØ¯Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ Ù„ÛŒØ¯Ø± -->
  <div id="leader-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-[#0A1F2E]/80 rounded-3xl p-8 md:p-10 max-w-lg w-full mx-4 md:mx-6 border border-[#2E9F73]/30 shadow-2xl">
      <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-6 md:mb-8 text-[#EAF5F1]">Ø§ÙØ²ÙˆØ¯Ù† Ù„ÛŒØ¯Ø± Ø¬Ø¯ÛŒØ¯</h2>
      <form id="leader-form" class="space-y-5 md:space-y-6">
        <input type="hidden" id="leader-id-input" name="leader_id" value="">
        <div>
          <label class="block text-[#B6E9D6] text-base md:text-lg font-medium mb-2 md:mb-3">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
          <input type="text" id="username-input" name="username" required
                 class="w-full bg-[#0A1F2E] border border-[#2E9F73]/50 rounded-2xl px-5 py-3 md:px-6 md:py-4 text-[#EAF5F1] text-base md:text-lg focus:outline-none focus:border-[#B6E9D6] focus:ring-4 focus:ring-[#B6E9D6]/30 transition-all duration-300">
        </div>
        <div>
          <label class="block text-[#B6E9D6] text-base md:text-lg font-medium mb-2 md:mb-3">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
          <input type="password" id="password-input" name="password"
                 class="w-full bg-[#0A1F2E] border border-[#2E9F73]/50 rounded-2xl px-5 py-3 md:px-6 md:py-4 text-[#EAF5F1] text-base md:text-lg placeholder-[#EAF5F1]/50 focus:outline-none focus:border-[#B6E9D6] focus:ring-4 focus:ring-[#B6E9D6]/30 transition-all duration-300"
                 placeholder="Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯">
        </div>
        <div class="flex flex-col sm:flex-row gap-4">
          <button type="submit" class="flex-1 px-6 py-3.5 bg-[#2E9F73] hover:bg-[#B6E9D6] text-white text-base md:text-lg font-bold rounded-2xl transition-all duration-300 transform hover:scale-105 hover:shadow-[0_0_30px_rgba(46,159,115,0.5)]">
            Ø°Ø®ÛŒØ±Ù‡
          </button>
          <button type="button" id="cancel-modal-btn" class="flex-1 px-6 py-3.5 bg-gray-700 hover:bg-gray-600 text-white text-base md:text-lg font-bold rounded-2xl transition-all duration-300 transform hover:scale-105">
            Ø§Ù†ØµØ±Ø§Ù
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Ø±ÛŒØ³Øª Ø±Ù…Ø² -->
  <div id="reset-password-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-[#0A1F2E]/80 rounded-3xl p-8 md:p-10 max-w-lg w-full mx-4 md:mx-6 border border-[#2E9F73]/30 shadow-2xl">
      <h2 class="text-2xl md:text-3xl font-bold mb-6 text-[#EAF5F1]">Ø±ÛŒØ³Øª Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</h2>
      <p class="text-base md:text-lg text-[#EAF5F1]/80 mb-8" id="reset-username-text"></p>
      <form id="reset-password-form" class="space-y-6">
        <input type="hidden" id="reset-leader-id-input" name="leader_id" value="">
        <div>
          <label class="block text-[#B6E9D6] text-base md:text-lg font-medium mb-3">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯</label>
          <input type="password" id="reset-password-input" name="password" required
                 class="w-full bg-[#0A1F2E] border border-[#2E9F73]/50 rounded-2xl px-5 py-3 md:px-6 md:py-4 text-[#EAF5F1] text-base md:text-lg focus:outline-none focus:border-[#B6E9D6] focus:ring-4 focus:ring-[#B6E9D6]/30 transition-all duration-300">
        </div>
        <div class="flex flex-col sm:flex-row gap-4">
          <button type="submit" class="flex-1 px-6 py-3.5 bg-[#2E9F73] hover:bg-[#B6E9D6] text-white text-base md:text-lg font-bold rounded-2xl transition-all duration-300 transform hover:scale-105 hover:shadow-[0_0_30px_rgba(46,159,115,0.5)]">
            Ø°Ø®ÛŒØ±Ù‡
          </button>
          <button type="button" id="cancel-reset-btn" class="flex-1 px-6 py-3.5 bg-gray-700 hover:bg-gray-600 text-white text-base md:text-lg font-bold rounded-2xl transition-all duration-300 transform hover:scale-105">
            Ø§Ù†ØµØ±Ø§Ù
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return "";
  }

  const csrftoken = getCookie("csrftoken");

  function showAlert(message, type="error") {
    const alertArea = document.getElementById("alert-area");
    const bg = type === "error" ? "bg-red-900/40" : "bg-green-900/40";
    const text = type === "error" ? "text-red-300" : "text-green-300";
    alertArea.innerHTML = `
      <div class="${bg} ${text} px-5 py-3 rounded-2xl text-sm mb-6 border border-red-500/30">
        ${message}
      </div>
    `;
    setTimeout(() => { alertArea.innerHTML = ""; }, 3000);
  }

  // Modal Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´
  const addLeaderBtn = document.getElementById("add-leader-btn");
  const leaderModal = document.getElementById("leader-modal");
  const leaderForm = document.getElementById("leader-form");
  const cancelModalBtn = document.getElementById("cancel-modal-btn");

  addLeaderBtn.addEventListener("click", () => {
    document.getElementById("modal-title").textContent = "Ø§ÙØ²ÙˆØ¯Ù† Ù„ÛŒØ¯Ø± Ø¬Ø¯ÛŒØ¯";
    document.getElementById("leader-id-input").value = "";
    document.getElementById("username-input").value = "";
    document.getElementById("password-input").value = "";
    document.getElementById("password-input").required = true;
    leaderModal.classList.remove("hidden");
  });

  cancelModalBtn.addEventListener("click", () => {
    leaderModal.classList.add("hidden");
  });

  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const leaderId = btn.dataset.leaderId;
      const username = btn.dataset.username;
      document.getElementById("modal-title").textContent = "ÙˆÛŒØ±Ø§ÛŒØ´ Ù„ÛŒØ¯Ø±";
      document.getElementById("leader-id-input").value = leaderId;
      document.getElementById("username-input").value = username;
      document.getElementById("password-input").value = "";
      document.getElementById("password-input").required = false;
      leaderModal.classList.remove("hidden");
    });
  });

  leaderForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const leaderId = document.getElementById("leader-id-input").value;
    const username = document.getElementById("username-input").value.trim();
    const password = document.getElementById("password-input").value.trim();

    const formData = new FormData();
    formData.append("username", username);
    if (password) {
      formData.append("password", password);
    }

    const url = leaderId
      ? `/exhibition-admin/leaders/${leaderId}/edit/`
      : "/exhibition-admin/leaders/create/";

    try {
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
        },
        body: formData,
      });

      const data = await response.json();
      if (!response.ok || data.error) {
        showAlert(data.error || "Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.");
      } else {
        showAlert("Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.", "success");
        leaderModal.classList.add("hidden");
        setTimeout(() => window.location.reload(), 1000);
      }
    } catch (e) {
      showAlert("Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.");
    }
  });

  // Modal Ø±ÛŒØ³Øª Ø±Ù…Ø²
  const resetPasswordModal = document.getElementById("reset-password-modal");
  const resetPasswordForm = document.getElementById("reset-password-form");
  const cancelResetBtn = document.getElementById("cancel-reset-btn");

  document.querySelectorAll(".reset-password-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const leaderId = btn.dataset.leaderId;
      const username = btn.dataset.username;
      document.getElementById("reset-leader-id-input").value = leaderId;
      document.getElementById("reset-username-text").textContent = `Ù„ÛŒØ¯Ø±: ${username}`;
      document.getElementById("reset-password-input").value = "";
      resetPasswordModal.classList.remove("hidden");
    });
  });

  cancelResetBtn.addEventListener("click", () => {
    resetPasswordModal.classList.add("hidden");
  });

  resetPasswordForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const leaderId = document.getElementById("reset-leader-id-input").value;
    const password = document.getElementById("reset-password-input").value.trim();

    const formData = new FormData();
    formData.append("password", password);

    try {
      const response = await fetch(`/exhibition-admin/leaders/${leaderId}/reset-password/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
        },
        body: formData,
      });

      const data = await response.json();
      if (!response.ok || data.error) {
        showAlert(data.error || "Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.");
      } else {
        showAlert("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.", "success");
        resetPasswordModal.classList.add("hidden");
      }
    } catch (e) {
      showAlert("Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.");
    }
  });

  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const leaderId = btn.dataset.leaderId;
      const username = btn.dataset.username;

      if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù„ÛŒØ¯Ø± "${username}" Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ`)) {
        return;
      }

      try {
        const response = await fetch(`/exhibition-admin/leaders/${leaderId}/delete/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrftoken,
          },
        });

        const data = await response.json();
        if (!response.ok || data.error) {
          showAlert(data.error || "Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.");
        } else {
          showAlert("Ù„ÛŒØ¯Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.", "success");
          setTimeout(() => window.location.reload(), 1000);
        }
      } catch (e) {
        showAlert("Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.");
      }
    });
  });
</script>
</body>
</html>