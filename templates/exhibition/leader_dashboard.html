{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù„ÛŒØ¯Ø±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/vazirmatn@33.0.4/Vazirmatn-font-face.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body class="bg-[#15173D] min-h-screen text-[#F1E9E9] font-vazirmatn">
  <script>
    if (sessionStorage.getItem('just_logged_in') === 'true') {
      sessionStorage.removeItem('just_logged_in');
      window.location.reload();
    }
  </script>
  <div class="max-w-3xl mx-auto py-10 px-6">
    <div class="flex justify-between items-center mb-10 flex-wrap gap-6">
      <h1 class="text-3xl md:text-4xl font-bold">
        Ù…Ø¯ÛŒØ±ÛŒØª ØºØ±ÙÙ‡â€ŒÙ‡Ø§
        {% if user.last_name %}
          ({{ user.last_name }} ğŸ™‹â€â™‚ï¸)
        {% elif user.first_name %}
          ({{ user.first_name }} ğŸ™‹â€â™‚ï¸)
        {% else %}
          ({{ user.username }} ğŸ™‹â€â™‚ï¸)
        {% endif %}
      </h1>
      
      {% if user.is_authenticated %}
        <form action="{% url 'logout' %}" method="post" class="inline">
          {% csrf_token %}
          <button type="submit"
                  class="px-6 py-3 bg-red-700 hover:bg-red-600 text-white rounded-2xl text-base font-medium transition-all duration-300 transform hover:scale-105 hover:shadow-[0_0_25px_rgba(255,107,107,0.5)]">
            Ø®Ø±ÙˆØ¬
          </button>
        </form>
      {% endif %}
    </div>

    <div id="alert-area" class="mb-6"></div>

    <div class="space-y-6">
      {% for booth in booths %}
        <div id="booth-card-{{ booth.id }}"
             class="bg-[#1E1F3D] rounded-3xl shadow-xl p-6 border border-[#982598]/20 hover:border-[#E491C9]/50 transition-all duration-300 hover:shadow-[0_0_30px_rgba(228,145,201,0.3)] hover:scale-[1.02]">
          <div class="flex justify-between items-center mb-4">
            <span class="text-xl font-bold text-[#E491C9]">
              {{ booth.name }}
            </span>
            <span class="text-sm text-[#F1E9E9]/70">
              Ø¸Ø±ÙÛŒØª: {{ booth.max }}
            </span>
          </div>

          <div class="flex justify-between items-center mb-4 text-sm">
            <span id="occupied-{{ booth.id }}">
              Ø§Ø´ØºØ§Ù„: {{ booth.occupied }} / {{ booth.max }}
            </span>
            <span id="remaining-{{ booth.id }}">
              Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: {{ booth.remaining }}
            </span>
          </div>

          <div class="flex space-x-4 space-x-reverse">
            <button
              data-booth-id="{{ booth.id }}"
              class="enter-btn flex-1 px-6 py-3.5 rounded-2xl text-white text-base font-medium transition-all duration-300 transform hover:scale-105
                     {% if booth.remaining <= 0 %}bg-gray-700 cursor-not-allowed{% else %}bg-[#982598] hover:bg-[#E491C9] hover:shadow-[0_0_25px_rgba(228,145,201,0.5)]{% endif %}">
              ÙˆØ±ÙˆØ¯
            </button>

            <button
              data-booth-id="{{ booth.id }}"
              class="exit-btn flex-1 px-6 py-3.5 rounded-2xl text-white text-base font-medium transition-all duration-300 transform hover:scale-105
                     {% if booth.is_user_inside %}bg-red-700 hover:bg-red-600 hover:shadow-[0_0_25px_rgba(255,107,107,0.5)]{% else %}bg-gray-700 cursor-not-allowed{% endif %}">
              Ø®Ø±ÙˆØ¬
            </button>
          </div>
        </div>
      {% endfor %}
    </div>

    <p class="text-center text-[#F1E9E9]/50 text-sm mt-12">
      DEVELOPED BY DEVSHIDO
    </p>
  </div>

<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return "";
  }

  const csrftoken = getCookie("csrftoken");

  function showAlert(message, type="error") {
    const alertArea = document.getElementById("alert-area");
    const bg = type === "error" ? "bg-red-900/40" : "bg-green-900/40";
    const text = type === "error" ? "text-red-300" : "text-green-300";
    alertArea.innerHTML = `
      <div class="${bg} ${text} px-5 py-3 rounded-2xl text-sm mb-6 border border-red-500/30">
        ${message}
      </div>
    `;
    setTimeout(() => { alertArea.innerHTML = ""; }, 3000);
  }

  async function postAction(url) {
    try {
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      if (!response.ok) {
        showAlert("Ø¯Ø± Ø§Ù†Ø¬Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
        return;
      }

      pollAllBoothsStatus();
      pollLeaderStatus();
      showAlert("Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.", "success");
    } catch (e) {
      showAlert("Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.");
    }
  }

  document.querySelectorAll(".enter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const boothId = btn.dataset.boothId;
      if (btn.classList.contains("cursor-not-allowed")) return;
      postAction(`/booths/${boothId}/enter/`);
    });
  });

  document.querySelectorAll(".exit-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const boothId = btn.dataset.boothId;
      if (btn.classList.contains("cursor-not-allowed")) return;
      postAction(`/booths/${boothId}/exit/`);
    });
  });

  function updateExitButtons(activeBoothIds) {
    document.querySelectorAll(".exit-btn").forEach(btn => {
      const boothId = parseInt(btn.dataset.boothId);
      if (activeBoothIds.includes(boothId)) {
        btn.classList.remove("bg-gray-700", "cursor-not-allowed");
        btn.classList.add("bg-red-700");
      } else {
        btn.classList.add("bg-gray-700", "cursor-not-allowed");
        btn.classList.remove("bg-red-700");
      }
    });
  }

  async function pollAllBoothsStatus() {
    try {
      const response = await fetch("/leader/api/all-booths-status/", {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      if (!response.ok) return;

      const payload = await response.json();
      if (!payload.booths || !Array.isArray(payload.booths)) return;

      payload.booths.forEach(booth => {
        const boothId = booth.id;
        const occupiedSpan = document.getElementById(`occupied-${boothId}`);
        const remainingSpan = document.getElementById(`remaining-${boothId}`);

        if (occupiedSpan && remainingSpan) {
          const total = booth.occupied + booth.remaining;
          occupiedSpan.textContent = `Ø§Ø´ØºØ§Ù„: ${booth.occupied} / ${total}`;
          remainingSpan.textContent = `Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${booth.remaining}`;
        }

        const enterBtn = document.querySelector(`.enter-btn[data-booth-id="${boothId}"]`);
        if (enterBtn) {
          if (booth.remaining <= 0) {
            enterBtn.classList.add("bg-gray-700", "cursor-not-allowed");
            enterBtn.classList.remove("bg-[#982598]");
          } else {
            enterBtn.classList.remove("bg-gray-700", "cursor-not-allowed");
            enterBtn.classList.add("bg-[#982598]");
          }
        }
      });
    } catch (e) {
      console.log("Ø®Ø·Ø§ Ø¯Ø± polling ÙˆØ¶Ø¹ÛŒØª ØºØ±ÙÙ‡â€ŒÙ‡Ø§:", e);
    }
  }

  async function pollLeaderStatus() {
    try {
      const response = await fetch("/leader/api/status/", {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      if (!response.ok) return;
      const data = await response.json();
      if (data.active_booth_ids && Array.isArray(data.active_booth_ids)) {
        updateExitButtons(data.active_booth_ids);
      }
    } catch (e) {}
  }

  setInterval(pollAllBoothsStatus, 3000);
  setInterval(pollLeaderStatus, 2000);
  pollAllBoothsStatus();
  pollLeaderStatus();
</script>
</body>
</html>