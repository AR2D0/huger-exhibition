{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù„ÛŒØ¯Ø±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.fontcdn.ir/Font/Persian/Shabnam/Shabnam.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <style>
    body, * { font-family: 'Shabnam', sans-serif !important; }
  </style>
</head>
<body class="bg-[#0A1F2E] min-h-screen text-[#EAF5F1] font-shabnam">

  <div class="max-w-3xl mx-auto py-10 px-6">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
      <h1 class="text-2xl md:text-3xl font-bold">
        ØºØ±ÙÙ‡ Ù‡Ø§
        {% if user.last_name %}
          ({{ user.last_name }} ğŸ™‹â€â™‚ï¸)
        {% elif user.first_name %}
          ({{ user.first_name }} ğŸ™‹â€â™‚ï¸)
        {% else %}
          ({{ user.username }} ğŸ™‹â€â™‚ï¸)
        {% endif %}
      </h1>

      <div class="flex flex-wrap items-center gap-3">
        <button id="reset-checks-btn"
                class="px-5 py-2.5 bg-red-700 hover:bg-red-600 text-white rounded-2xl text-sm md:text-base font-medium transition-all duration-300 transform hover:scale-105 hover:shadow-[0_0_20px_rgba(255,107,107,0.5)]">
          Ø±ÛŒØ³Øª Ù‡Ù…Ù‡ ØªÛŒÚ©â€ŒÙ‡Ø§
        </button>

        {% if user.is_authenticated %}
          <form action="{% url 'logout' %}" method="post" class="inline">
            {% csrf_token %}
            <button type="submit"
                    class="px-5 py-2.5 bg-gray-700 hover:bg-gray-600 text-white rounded-xl text-sm md:text-base font-medium transition-all duration-300 transform hover:scale-105">
              Ø®Ø±ÙˆØ¬
            </button>
          </form>
        {% endif %}
      </div>
    </div>

    <div id="alert-area" class="mb-6"></div>

    <div class="space-y-6">
      {% for booth in booths %}
        <div id="booth-card-{{ booth.id }}"
             class="bg-[#0A1F2E]/80 rounded-3xl shadow-xl p-6 border border-[#2E9F73]/30 hover:border-[#B6E9D6]/50 transition-all duration-300 hover:shadow-[0_0_30px_rgba(46,159,115,0.3)] hover:scale-[1.02] flex items-start gap-4">
          
          <!-- ØªÛŒÚ©â€ŒØ¨Ø§Ú©Ø³ -->
          <div class="pt-1">
            <input type="checkbox" id="check-{{ booth.id }}" class="w-6 h-6 accent-[#2E9F73] cursor-pointer">
          </div>

          <div class="flex-1">
            <div class="flex justify-between items-center mb-4">
              <span class="text-xl font-bold text-[#B6E9D6]">
                {{ booth.name }}
              </span>
              <span class="text-sm text-[#EAF5F1]/70">
                Ø¸Ø±ÙÛŒØª: {{ booth.max_groups }}
              </span>
            </div>

            <div class="flex justify-between items-center mb-4 text-sm">
              <span id="occupied-{{ booth.id }}">
                Ø§Ø´ØºØ§Ù„: {{ booth.occupied }} / {{ booth.max_groups }}
              </span>
              <span id="remaining-{{ booth.id }}">
                Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: {{ booth.remaining }}
              </span>
            </div>

            <div class="flex space-x-4 space-x-reverse">
              <button
                data-booth-id="{{ booth.id }}"
                class="enter-btn flex-1 px-6 py-3.5 rounded-2xl text-white text-base font-medium transition-all duration-300 transform hover:scale-105
                       {% if booth.remaining <= 0 %}bg-gray-700 cursor-not-allowed{% else %}bg-[#2E9F73] hover:bg-[#B6E9D6] hover:shadow-[0_0_25px_rgba(46,159,115,0.5)]{% endif %}">
                ÙˆØ±ÙˆØ¯
              </button>

              <button
                data-booth-id="{{ booth.id }}"
                class="exit-btn flex-1 px-6 py-3.5 rounded-2xl text-white text-base font-medium transition-all duration-300 transform hover:scale-105
                       {% if booth.is_user_inside %}bg-red-700 hover:bg-red-600 hover:shadow-[0_0_25px_rgba(255,107,107,0.5)]{% else %}bg-gray-700 cursor-not-allowed{% endif %}">
                Ø®Ø±ÙˆØ¬
              </button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <p class="text-center text-[#EAF5F1]/50 text-sm mt-12">
      DEVELOPED BY DEVSHIDO
    </p>
  </div>

<script>
  // Ù„ÙˆØ¯ ÙˆØ¶Ø¹ÛŒØª ØªÛŒÚ©â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
  async function loadCheckedBooths() {
    try {
      const response = await fetch("/leader/checked-booths/", {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      if (!response.ok) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ú¯Ø±ÙØªÙ† ØªÛŒÚ©â€ŒÙ‡Ø§:", response.status);
        return;
      }

      const data = await response.json();
      console.log("ØªÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡:", data); // Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ - Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Ø¨Ø¨ÛŒÙ†

      const checkedIds = data.checked_booth_ids || [];

      document.querySelectorAll('input[type="checkbox"][id^="check-"]').forEach(checkbox => {
        const boothId = checkbox.id.replace('check-', '');
        checkbox.checked = checkedIds.includes(parseInt(boothId));
      });
    } catch (e) {
      console.error("Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ ØªÛŒÚ©â€ŒÙ‡Ø§:", e);
    }
  }

  // ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ù„ÙˆØ¯ Ø´Ø¯
  window.addEventListener('load', () => {
    loadCheckedBooths();
  });

  // ÙˆÙ‚ØªÛŒ Ú†Ú©â€ŒØ¨Ø§Ú©Ø³ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ØŒ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨ÙØ±Ø³Øª (ÙÛŒÚ©Ø³ Ø§ØµÙ„ÛŒ)
  document.querySelectorAll('input[type="checkbox"][id^="check-"]').forEach(checkbox => {
    checkbox.addEventListener('change', async () => {
      const boothId = checkbox.id.replace('check-', '');
      
      try {
        const response = await fetch(`/leader/toggle-check/${boothId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
          },
        });

        if (!response.ok) {
          console.error("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÛŒÚ©:", response.status);
          checkbox.checked = !checkbox.checked; // Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ† Ø¨Ù‡ Ø­Ø§Ù„Øª Ù‚Ø¨Ù„
          showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÛŒÚ©.', 'error');
          return;
        }

        const data = await response.json();
        console.log("ØªÛŒÚ© ØªØºÛŒÛŒØ± Ú©Ø±Ø¯:", data);
      } catch (e) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©:", e);
        checkbox.checked = !checkbox.checked; // Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†
        showAlert('Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.', 'error');
      }
    });
  });

  // Ø¯Ú©Ù…Ù‡ Ø±ÛŒØ³Øª Ù‡Ù…Ù‡ ØªÛŒÚ©â€ŒÙ‡Ø§
  document.getElementById('reset-checks-btn').addEventListener('click', async () => {
    if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‡Ù…Ù‡ ØªÛŒÚ©â€ŒÙ‡Ø§ Ø±Ø§ Ø±ÛŒØ³Øª Ú©Ù†ÛŒØ¯ØŸ')) return;

    try {
      const response = await fetch('/leader/reset-all-checks/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest',
        },
      });

      if (response.ok) {
        document.querySelectorAll('input[type="checkbox"][id^="check-"]').forEach(checkbox => {
          checkbox.checked = false;
        });
        showAlert('Ù‡Ù…Ù‡ ØªÛŒÚ©â€ŒÙ‡Ø§ Ø±ÛŒØ³Øª Ø´Ø¯.', 'success');
      } else {
        showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø±ÛŒØ³Øª ØªÛŒÚ©â€ŒÙ‡Ø§.', 'error');
      }
    } catch (e) {
      showAlert('Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.', 'error');
    }
  });

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return "";
  }

  const csrftoken = getCookie("csrftoken");

  function showAlert(message, type="error") {
    const alertArea = document.getElementById("alert-area");
    const bg = type === "error" ? "bg-red-900/40" : "bg-green-900/40";
    const text = type === "error" ? "text-red-300" : "text-green-300";
    alertArea.innerHTML = `
      <div class="${bg} ${text} px-5 py-3 rounded-2xl text-sm mb-6 border border-red-500/30">
        ${message}
      </div>
    `;
    setTimeout(() => { alertArea.innerHTML = ""; }, 3000);
  }

  async function postAction(url) {
    try {
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      if (!response.ok) {
        showAlert("Ø¯Ø± Ø§Ù†Ø¬Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.", 'error');
        return;
      }

      pollAllBoothsStatus();
      pollLeaderStatus();
    } catch (e) {
      showAlert("Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.", 'error');
    }
  }

  document.querySelectorAll(".enter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const boothId = btn.dataset.boothId;
      if (btn.classList.contains("cursor-not-allowed")) return;
      postAction(`/booths/${boothId}/enter/`);
    });
  });

  document.querySelectorAll(".exit-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const boothId = btn.dataset.boothId;
      if (btn.classList.contains("cursor-not-allowed")) return;
      postAction(`/booths/${boothId}/exit/`);
    });
  });

  function updateExitButtons(activeBoothIds) {
    document.querySelectorAll(".exit-btn").forEach(btn => {
      const boothId = parseInt(btn.dataset.boothId);
      if (activeBoothIds.includes(boothId)) {
        btn.classList.remove("bg-gray-700", "cursor-not-allowed");
        btn.classList.add("bg-red-700");
      } else {
        btn.classList.add("bg-gray-700", "cursor-not-allowed");
        btn.classList.remove("bg-red-700");
      }
    });
  }

  async function pollAllBoothsStatus() {
    try {
      const response = await fetch("/leader/api/all-booths-status/", {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      if (!response.ok) return;

      const payload = await response.json();
      if (!payload.booths || !Array.isArray(payload.booths)) return;

      payload.booths.forEach(booth => {
        const boothId = booth.id;
        const occupiedSpan = document.getElementById(`occupied-${boothId}`);
        const remainingSpan = document.getElementById(`remaining-${boothId}`);

        if (occupiedSpan && remainingSpan) {
          const total = booth.occupied + booth.remaining;
          occupiedSpan.textContent = `Ø§Ø´ØºØ§Ù„: ${booth.occupied} / ${total}`;
          remainingSpan.textContent = `Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${booth.remaining}`;
        }

        const enterBtn = document.querySelector(`.enter-btn[data-booth-id="${boothId}"]`);
        if (enterBtn) {
          if (booth.remaining <= 0) {
            enterBtn.classList.add("bg-gray-700", "cursor-not-allowed");
            enterBtn.classList.remove("bg-[#2E9F73]", "hover:bg-[#B6E9D6]");
            enterBtn.title = "Ø§ÛŒÙ† ØºØ±ÙÙ‡ Ù¾Ø± Ø§Ø³Øª.";
          } else {
            enterBtn.classList.remove("bg-gray-700", "cursor-not-allowed");
            enterBtn.classList.add("bg-[#2E9F73]", "hover:bg-[#B6E9D6]");
            enterBtn.removeAttribute('title');
          }
        }
      });
    } catch (e) {
      console.log("Ø®Ø·Ø§ Ø¯Ø± polling:", e);
    }
  }

  async function pollLeaderStatus() {
    try {
      const response = await fetch("/leader/api/status/", {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      if (!response.ok) return;
      const data = await response.json();
      if (data.active_booth_ids && Array.isArray(data.active_booth_ids)) {
        updateExitButtons(data.active_booth_ids);
      }
    } catch (e) {}
  }

  setInterval(pollAllBoothsStatus, 3000);
  setInterval(pollLeaderStatus, 2000);
  pollAllBoothsStatus();
  pollLeaderStatus();
</script>
</body>
</html>