{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ ØºØ±ÙÙ‡â€ŒÙ‡Ø§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.fontcdn.ir/Font/Persian/Shabnam/Shabnam.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <style>
    body, * { font-family: 'Shabnam', sans-serif !important; }
  </style>
</head>
<body class="bg-[#0A1F2E] min-h-screen text-[#EAF5F1] font-shabnam">
  <script>
    if (sessionStorage.getItem('just_logged_in') === 'true') {
      sessionStorage.removeItem('just_logged_in');
      window.location.reload();
    }
  </script>
  <div class="max-w-6xl mx-auto py-10 px-6">
    <div class="flex justify-between items-center mb-10 flex-wrap gap-6">
      <h1 class="text-2xl md:text-3xl font-bold">
        Ù…Ø¯ÛŒØ±ÛŒØª ØºØ±ÙÙ‡ Ù‡Ø§
        {% if user.last_name %}
          ({{ user.last_name }} ğŸ™‹â€â™‚ï¸)
        {% elif user.first_name %}
          ({{ user.first_name }} ğŸ™‹â€â™‚ï¸)
        {% else %}
          ({{ user.username }} ğŸ™‹â€â™‚ï¸)
        {% endif %}
      </h1>

      <div class="flex items-center space-x-5 space-x-reverse">
        <a href="/exhibition-admin/leaders/"
           class="px-6 py-3 bg-[#2E9F73] hover:bg-[#B6E9D6] text-white rounded-xl text-base font-medium transition-all duration-300 transform hover:scale-105 hover:shadow-[0_0_25px_rgba(46,159,115,0.5)]">
          Ù…Ø¯ÛŒØ±ÛŒØª Ù„ÛŒØ¯Ø±Ù‡Ø§
        </a>

        {% if user.is_authenticated %}
          <form action="{% url 'logout' %}" method="post" class="inline">
            {% csrf_token %}
            <button type="submit"
                    class="px-5 py-2.5 bg-red-700 hover:bg-red-600 text-white rounded-2xl text-base font-medium transition-all duration-300 transform hover:scale-105 hover:shadow-[0_0_25px_rgba(255,107,107,0.5)]">
              Ø®Ø±ÙˆØ¬
            </button>
          </form>
        {% endif %}
      </div>
    </div>

    <div id="alert-area" class="mb-6"></div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for item in booth_status %}
        <div id="admin-booth-card-{{ item.booth.id }}"
             class="bg-[#0A1F2E]/80 rounded-3xl shadow-xl p-6 border border-[#2E9F73]/30 hover:border-[#B6E9D6]/50 transition-all duration-300 hover:shadow-[0_0_30px_rgba(46,159,115,0.3)] hover:scale-[1.02]">
          <div class="flex justify-between items-center mb-4">
            <span class="text-xl font-bold text-[#B6E9D6]">
              {{ item.booth.name }}
            </span>
            <span class="text-sm text-[#EAF5F1]/70">
              Ø¸Ø±ÙÛŒØª Ú©Ù„: {{ item.booth.max_groups }}
            </span>
          </div>

          <div class="flex justify-between items-center mb-4 text-sm">
            <span id="admin-occupied-{{ item.booth.id }}">
              Ø§Ø´ØºØ§Ù„: {{ item.occupied }} / {{ item.booth.max_groups }}
            </span>
            <span id="admin-remaining-{{ item.booth.id }}">
              Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: {{ item.remaining }}
            </span>
          </div>

          <div>
            <h3 class="text-base font-semibold text-[#2E9F73] mb-3">Ù„ÛŒØ¯Ø±Ù‡Ø§ÛŒ Ø­Ø§Ø¶Ø±:</h3>
            <ul id="admin-leaders-{{ item.booth.id }}" class="space-y-2 text-sm">
              {% for leader in item.leaders %}
                <li class="flex justify-between items-center bg-[#0A1F2E]/50 p-3 rounded-2xl border border-[#2E9F73]/10 hover:border-[#B6E9D6]/40 transition-all duration-300">
                  <span class="text-[#EAF5F1]">{{ leader.username }}</span>
                  <button
                    data-booth-id="{{ item.booth.id }}"
                    data-user-id="{{ leader.id }}"
                    class="kick-btn text-xs px-4 py-2 bg-red-700 hover:bg-red-600 rounded-xl transition-all duration-300 hover:scale-105">
                    Ø§Ø®Ø±Ø§Ø¬
                  </button>
                </li>
              {% empty %}
                <li class="text-[#EAF5F1]/50 text-center py-3">Ù‡ÛŒÚ† Ù„ÛŒØ¯Ø±ÛŒ Ø¯Ø± Ø§ÛŒÙ† ØºØ±ÙÙ‡ Ù†ÛŒØ³Øª.</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      {% endfor %}
    </div>

    <p class="text-center text-[#EAF5F1]/50 text-sm mt-12">
      DEVELOPED BY DEVSHIDO
    </p>
  </div>

<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return "";
  }

  const csrftoken = getCookie("csrftoken");

  function showAlert(message, type="error") {
    const alertArea = document.getElementById("alert-area");
    const bg = type === "error" ? "bg-red-900/40" : "bg-green-900/40";
    const text = type === "error" ? "text-red-300" : "text-green-300";
    alertArea.innerHTML = `
      <div class="${bg} ${text} px-5 py-3 rounded-2xl text-sm mb-6 border border-red-500/30">
        ${message}
      </div>
    `;
    setTimeout(() => { alertArea.innerHTML = ""; }, 3000);
  }

  async function postKick(url) {
    try {
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      if (!response.ok) {
        showAlert("Ø¯Ø± Ø§Ù†Ø¬Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
        return;
      }

      showAlert("Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.", "success");
    } catch (e) {
      showAlert("Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.");
    }
  }

  document.querySelectorAll(".kick-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const boothId = btn.dataset.boothId;
      const userId = btn.dataset.userId;
      const url = `/exhibition-admin/booths/${boothId}/kick/${userId}/`;
      postKick(url);
    });
  });

  function applySnapshotFromBooth(booth) {
    const boothId = booth.id;

    const occupiedSpan = document.getElementById(`admin-occupied-${boothId}`);
    const remainingSpan = document.getElementById(`admin-remaining-${boothId}`);
    if (occupiedSpan && remainingSpan) {
      const total = booth.occupied + booth.remaining;
      occupiedSpan.textContent = `Ø§Ø´ØºØ§Ù„: ${booth.occupied} / ${total}`;
      remainingSpan.textContent = `Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${booth.remaining}`;
    }

    const list = document.getElementById(`admin-leaders-${boothId}`);
    if (list) {
      list.innerHTML = "";
      if (!booth.leaders || booth.leaders.length === 0) {
        list.innerHTML = '<li class="text-gray-500 text-sm">Ù‡ÛŒÚ† Ù„ÛŒØ¯Ø±ÛŒ Ø¯Ø± Ø§ÛŒÙ† ØºØ±ÙÙ‡ Ù†ÛŒØ³Øª.</li>';
      } else {
        booth.leaders.forEach(leader => {
          const li = document.createElement("li");
          li.className = "flex justify-between items-center border-b pb-1";

          const username = typeof leader === "string" ? leader : leader.username;
          const leaderId = typeof leader === "object" && leader.id ? leader.id : null;

          if (leaderId) {
            li.innerHTML = `
              <span>${username}</span>
              <button
                data-booth-id="${boothId}"
                data-user-id="${leaderId}"
                class="kick-btn text-xs px-2 py-1 rounded bg-red-500 text-white">
                Ø§Ø®Ø±Ø§Ø¬
              </button>
            `;
            const kickBtn = li.querySelector(".kick-btn");
            if (kickBtn) {
              kickBtn.addEventListener("click", () => {
                const url = `/exhibition-admin/booths/${boothId}/kick/${leaderId}/`;
                postKick(url);
              });
            }
          } else {
            li.innerHTML = `
              <span>${username}</span>
              <span class="text-xs text-gray-400">Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
            `;
          }

          list.appendChild(li);
        });
      }
    }
  }

  try {
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${wsScheme}://${window.location.host}/ws/capacity/`);

    ws.onopen = function () {
      console.log("WebSocket Ø§Ø¯Ù…ÛŒÙ† Ù…ØªØµÙ„ Ø´Ø¯");
    };

    ws.onerror = function (error) {
      console.error("Ø®Ø·Ø§ÛŒ WebSocket Ø§Ø¯Ù…ÛŒÙ†:", error);
    };

    ws.onmessage = function (event) {
      console.log("Ù¾ÛŒØ§Ù… Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø² WebSocket:", event.data);

      let message;
      try {
        message = JSON.parse(event.data);
      } catch (e) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ø±Ø³ JSON Ø¯Ø± Ø§Ø¯Ù…ÛŒÙ†:", e);
        return;
      }

      if (message.type !== "capacity.update") {
        console.log("Ù¾ÛŒØ§Ù… Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± Ø§Ø¯Ù…ÛŒÙ†:", message);
        return;
      }

      applySnapshotFromBooth({
        id: message.booth_id,
        occupied: message.occupied,
        remaining: message.remaining,
        leaders: message.leaders || [],
      });
    };
  } catch (e) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ WebSocket Ø§Ø¯Ù…ÛŒÙ†:", e);
  }

  async function pollStatus() {
    try {
      const response = await fetch("/exhibition-admin/api/booth-status/", {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      if (!response.ok) return;
      const payload = await response.json();
      if (payload.booths && Array.isArray(payload.booths)) {
        payload.booths.forEach(applySnapshotFromBooth);
      }
    } catch (e) {}
  }

  setInterval(pollStatus, 1500);
</script>
</body>
</html>